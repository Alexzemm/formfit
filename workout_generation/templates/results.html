{% extends "base.html" %}

{% block title %}Plans for {{ user_info.name }}{% endblock %}

{% block content %}
<h1>üìã Personalized Dashboard for {{ user_info.name }}</h1>

<!-- Summary Tab (Profile Overview) -->
<div id="summaryTab" class="tab-content section">
    <h2>üë§ Profile Overview</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div style="background: rgba(90, 103, 216, 0.2); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üë§</div>
            <h3 style="color: #a3bffa; margin-bottom: 5px; font-size: 1rem;">Age & Gender</h3>
            <p style="font-size: 1.3rem; font-weight: 600; color: #f1f1f1;">{{ user_info.age }} years, {{ user_info.gender }}</p>
        </div>
        <div style="background: rgba(90, 103, 216, 0.2); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üìè</div>
            <h3 style="color: #a3bffa; margin-bottom: 5px; font-size: 1rem;">Height & Weight</h3>
            <p style="font-size: 1.3rem; font-weight: 600; color: #f1f1f1;">{{ user_info.height }} cm / {{ user_info.weight }} kg</p>
        </div>
        <div style="background: rgba(90, 103, 216, 0.2); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üéØ</div>
            <h3 style="color: #a3bffa; margin-bottom: 5px; font-size: 1rem;">Primary Goal</h3>
            <p style="font-size: 1.3rem; font-weight: 600; color: #f1f1f1;">{{ user_info.fitness_goal }}</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h3 style="color: #a3bffa; margin-bottom: 15px; font-size: 1.2rem;">üí™ Fitness Details</h3>
            <div style="background: rgba(45, 50, 64, 0.4); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <p style="margin: 8px 0;"><strong>Activity Level:</strong> {{ user_info.activity_level }}</p>
                <p style="margin: 8px 0;"><strong>Workout Days:</strong> {{ user_info.workout_days }} days/week</p>
                <p style="margin: 8px 0;"><strong>Session Duration:</strong> {{ user_info.workout_duration }} minutes</p>
                <p style="margin: 8px 0;"><strong>Location:</strong> {{ user_info.workout_location }}</p>
            </div>
        </div>
        <div>
            <h3 style="color: #a3bffa; margin-bottom: 15px; font-size: 1.2rem;">ü•ó Diet & Health</h3>
            <div style="background: rgba(45, 50, 64, 0.4); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <p style="margin: 8px 0;"><strong>Diet Type:</strong> {{ user_info.diet_preference }}</p>
                <p style="margin: 8px 0;"><strong>Allergies:</strong> {{ user_info.allergies or 'None specified' }}</p>
                <p style="margin: 8px 0;"><strong>Medical Conditions:</strong> {{ user_info.medical_conditions or 'None specified' }}</p>
            </div>
        </div>
    </div>

    <div style="margin-top: 25px; padding: 15px; background: rgba(90, 103, 216, 0.1); border-radius: 8px; border-left: 4px solid #a3bffa;">
        <p style="text-align: center; color: #b5b5b5; font-size: 0.95rem;">
            <strong>üìÖ Plans Generated:</strong> {{ timestamp }} | 
            <strong>üîÑ Status:</strong> <span style="color: #a3ffb0;">Active</span>
        </p>
    </div>

    <div style="display: flex; gap: 20px; margin-top: 30px;">
    <form method="POST" action="/save" style="flex: 1;">
        <input type="hidden" name="workout_plan" value="{{ workout_plan }}">
        <input type="hidden" name="diet_plan" value="{{ diet_plan }}">
        <input type="hidden" name="name" value="{{ user_info.name }}">
        <input type="hidden" name="age" value="{{ user_info.age }}">
        <input type="hidden" name="gender" value="{{ user_info.gender }}">
        <input type="hidden" name="height" value="{{ user_info.height }}">
        <input type="hidden" name="weight" value="{{ user_info.weight }}">
        <input type="hidden" name="fitness_goal" value="{{ user_info.fitness_goal }}">
        <input type="hidden" name="activity_level" value="{{ user_info.activity_level }}">
        <input type="hidden" name="workout_days" value="{{ user_info.workout_days }}">
        <input type="hidden" name="workout_duration" value="{{ user_info.workout_duration }}">
        <input type="hidden" name="workout_location" value="{{ user_info.workout_location }}">
        <input type="hidden" name="diet_preference" value="{{ user_info.diet_preference }}">
        <input type="hidden" name="allergies" value="{{ user_info.allergies }}">
        <input type="hidden" name="medical_conditions" value="{{ user_info.medical_conditions }}">
        <input type="hidden" name="country" value="{{ user_info.country }}">
        <button type="submit" onclick="savePlans(event)" style="background: rgba(72, 187, 120, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; box-shadow: 0 2px 8px rgba(72, 187, 120, 0.4), 0 0 20px rgba(72, 187, 120, 0.2); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 15px rgba(72, 187, 120, 0.5), 0 0 30px rgba(72, 187, 120, 0.3)'; this.style.background='rgba(92, 207, 140, 0.9)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(72, 187, 120, 0.4), 0 0 20px rgba(72, 187, 120, 0.2)'; this.style.background='rgba(72, 187, 120, 0.85)'">üíæ Save Plans</button>
    </form>
    <button onclick="window.location.href='/new'" style="flex: 1; background: rgba(237, 137, 54, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; box-shadow: 0 2px 8px rgba(237, 137, 54, 0.4), 0 0 20px rgba(237, 137, 54, 0.2); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 15px rgba(237, 137, 54, 0.5), 0 0 30px rgba(237, 137, 54, 0.3)'; this.style.background='rgba(255, 157, 74, 0.9)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(237, 137, 54, 0.4), 0 0 20px rgba(237, 137, 54, 0.2)'; this.style.background='rgba(237, 137, 54, 0.85)'">üîÑ Generate New Plans</button>
    </div>

    <div id="saveStatus" class="status" style="display: none;"></div>
</div>

<!-- Workout Plan Tab -->
<div id="workoutTab" class="tab-content section" style="display: none;">
    <h2>üèãÔ∏è Your Workout Plan</h2>
    <div id="workoutPlanContent" style="white-space: pre-line; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word;" data-content="{{ workout_plan|replace('\"', '&quot;')|replace('\n', '&#10;') }}"></div>
</div>

<!-- Diet Plan Tab -->
<div id="dietTab" class="tab-content section" style="display: none;">
    <h2>ü•ó Your Diet Plan</h2>
    <div id="dietPlanContent" style="white-space: pre-line; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word;" data-content="{{ diet_plan|replace('\"', '&quot;')|replace('\n', '&#10;') }}"></div>
</div>
{% endblock %}

{% block scripts %}
<style>
.tab-btn {
    background: rgba(35, 39, 47, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #b5b5b5;
    border: 2px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}
.tab-btn.active {
    background: linear-gradient(135deg, rgba(90, 103, 216, 0.8), rgba(242, 244, 246, 0.8));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #232526;
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 2px 8px rgba(90, 103, 216, 0.2);
}
.tab-content h3 {
    color: #a3bffa;
    margin: 15px 0 10px 0;
}
.tab-content p {
    margin: 5px 0;
    color: #b5b5b5;
}

/* Enhanced plan content styling */
.plan-content {
    font-size: 16px;
    background: rgba(35, 39, 47, 0.5);
    color: #f1f1f1;
}

/* Optimize rendering performance */
#workoutPlanContent, #dietPlanContent {
    contain: layout style paint;
    will-change: auto;
    transform: translateZ(0);
    -webkit-font-smoothing: antialiased;
    -webkit-overflow-scrolling: touch;
}

/* Remove backdrop filters from tab content for better scroll performance */
#workoutTab.section, #dietTab.section {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

/* Day headings */
.plan-content h3, 
.plan-content strong {
    color: #a3bffa;
    margin-top: 25px;
    margin-bottom: 10px;
    display: block;
    font-weight: 600;
}

/* Style day names specifically */
#workoutPlanContent {
    color: #f1f1f1;
}

#workoutPlanContent strong,
#workoutPlanContent b {
    color: #a3bffa !important;
}

/* Diet headings */
#dietPlanContent h3, 
#dietPlanContent strong {
    color: #ed8936;
}

/* Bullet points */
.plan-content ul {
    padding-left: 20px;
    margin: 10px 0;
}

.plan-content li {
    margin-bottom: 8px;
}

/* Weekly schedule and section formatting */
.plan-content p {
    margin: 8px 0;
}

/* Workout tables */
.workout-day-header {
    background: linear-gradient(135deg, rgba(90, 103, 216, 0.8), rgba(35, 37, 38, 0.6));
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #f1f1f1;
    padding: 10px 15px;
    border-radius: 6px;
    margin: 20px 0 15px;
    font-weight: 600;
    font-size: 1.1rem;
}

.workout-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    background: rgba(35, 39, 47, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.workout-table th {
    background: rgba(45, 50, 64, 0.7);
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: #a3bffa;
}

.workout-table td {
    padding: 12px 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    color: #f1f1f1;
}

.workout-table tr:nth-child(even) {
    background-color: rgba(35, 39, 47, 0.3);
}

.exercise-name {
    font-weight: 500;
}

.sets-reps {
    text-align: center;
    font-weight: 500;
}

.rest-time {
    color: #b5b5b5;
}
</style>

<script>
// Show the summary tab by default
document.addEventListener('DOMContentLoaded', function() {
    showTab('summary');
});

// Track which tabs have been loaded
const loadedTabs = new Set(['summary']);

function showTab(tabName) {
    const tabMap = {
        'summary': 'summaryTab',
        'workout': 'workoutTab',
        'diet': 'dietTab'
    };
    
    // Use requestAnimationFrame for smoother transitions
    requestAnimationFrame(() => {
        // Hide all tabs efficiently
        const allTabs = document.querySelectorAll('.tab-content');
        allTabs.forEach(tab => {
            if (tab.style.display !== 'none') {
                tab.style.display = 'none';
            }
        });
        
        // Show the selected tab
        const selectedTab = document.getElementById(tabMap[tabName]);
        if (selectedTab) {
            // Lazy load content only when first viewing the tab
            if (!loadedTabs.has(tabName) && tabName !== 'summary') {
                const contentDiv = selectedTab.querySelector('[data-content]');
                if (contentDiv && contentDiv.dataset.content) {
                    // Decode HTML entities and load content
                    const content = contentDiv.dataset.content
                        .replace(/&quot;/g, '"')
                        .replace(/&#10;/g, '\n');
                    
                    // Highlight day names and numbered sections in workout and diet plans
                    if (tabName === 'workout' || tabName === 'diet') {
                        let highlightedContent = content;
                        
                        // Choose color based on tab type
                        const headingColor = tabName === 'workout' ? '#a3bffa' : '#ed8936';
                        
                        // Convert markdown headings (# and ##) to styled divs
                        // H3 headings (### ) - process first to avoid conflicts
                        highlightedContent = highlightedContent.replace(/^###\s*(.+)$/gm, `<div style="color: ${headingColor}; font-weight: 600; font-size: 1.15rem; margin-top: 25px; margin-bottom: 12px;">$1</div>`);
                        
                        // H2 headings (## ) - with or without space after ##
                        highlightedContent = highlightedContent.replace(/^##\s*(.+)$/gm, `<div style="color: ${headingColor}; font-weight: 700; font-size: 1.25rem; margin-top: 30px; margin-bottom: 15px;">$1</div>`);
                        
                        // H1 headings (# ) - with or without space after #
                        highlightedContent = highlightedContent.replace(/^#\s*(.+)$/gm, `<div style="color: ${headingColor}; font-weight: 700; font-size: 1.4rem; margin-top: 35px; margin-bottom: 20px;">$1</div>`);
                        
                        // Also handle hashtags at the start of lines (like #Day 1)
                        highlightedContent = highlightedContent.replace(/^#([A-Z][^\n]+)$/gm, `<div style="color: ${headingColor}; font-weight: 600; font-size: 1.15rem; margin-top: 25px; margin-bottom: 12px;">$1</div>`);
                        
                        // Highlight day names with larger font
                        const dayPattern = /(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/gi;
                        highlightedContent = highlightedContent.replace(dayPattern, `<span style="color: ${headingColor}; font-weight: 600; font-size: 1.15rem;">$1</span>`);
                        
                        // Highlight numbered sections (e.g., "1. Weekly Workout Schedule", "2. Detailed Exercises")
                        const numberedPattern = /^(\d+\.\s+[^\n]+)/gm;
                        highlightedContent = highlightedContent.replace(numberedPattern, `<div style="color: ${headingColor}; font-weight: 700; font-size: 1.25rem; margin-top: 30px; margin-bottom: 15px;">$1</div>`);
                        
                        contentDiv.innerHTML = highlightedContent;
                    } else {
                        contentDiv.textContent = content;
                    }
                    
                    // Remove data attribute to free memory
                    delete contentDiv.dataset.content;
                    loadedTabs.add(tabName);
                }
            }
            
            selectedTab.style.display = 'block';
            // Scroll to top of page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
}

function savePlans(event) {
    event.preventDefault();
    const form = event.target.closest('form');
    const formData = new FormData(form);
    const status = document.getElementById('saveStatus');
    
    fetch('/save', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        status.style.display = 'block';
        if (data.success) {
            status.className = 'status success';
            status.textContent = data.success;
        } else {
            status.className = 'status error';
            status.textContent = data.error;
        }
    })
    .catch(error => {
        status.style.display = 'block';
        status.className = 'status error';
        status.textContent = 'Error saving files: ' + error.message;
    });
}
</script>
{% endblock %}